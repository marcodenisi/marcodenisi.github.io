<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Marco Denisi">
<meta name="description" content="During last weeks, I&rsquo;ve worked a lot with AWS Lambda.
The main challenge I had was to look for a method to locally test those functions. Of course, it is possible to do some partial code execution as part of unit/integration test setup, but that won’t be close enough to production setup.
I&rsquo;d like to build a sort of how-to guide in order to have a reference in the future.">

<meta property="og:title" content="Lambda Step by Step" />
<meta property="og:description" content="During last weeks, I&rsquo;ve worked a lot with AWS Lambda.
The main challenge I had was to look for a method to locally test those functions. Of course, it is possible to do some partial code execution as part of unit/integration test setup, but that won’t be close enough to production setup.
I&rsquo;d like to build a sort of how-to guide in order to have a reference in the future." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marcodenisi.dev/en/blog/lambda-step-by-step/" />
<meta property="article:published_time" content="2019-09-26T00:07:46&#43;02:00"/>
<meta property="article:modified_time" content="2019-09-26T00:07:46&#43;02:00"/>


<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://marcodenisi.dev"
        },
        "articleSection" : "blog",
        "name" : "Lambda Step by Step",
        "headline" : "Lambda Step by Step",
        "description" : "During last weeks, I&rsquo;ve worked a lot with AWS Lambda.
The main challenge I had was to look for a method to locally test those functions. Of course, it is possible to do some partial code execution as part of unit/integration test setup, but that won’t be close enough to production setup.
I&rsquo;d like to build a sort of how-to guide in order to have a reference in the future.",
        "inLanguage" : "en",
        "author" : "Marco Denisi",
        "creator" : "Marco Denisi",
        "publisher": "Marco Denisi",
        "accountablePerson" : "Marco Denisi",
        "copyrightHolder" : "Marco Denisi",
        "copyrightYear" : "2019",
        "datePublished": "2019-09-26 00:07:46 &#43;0200 &#43;0200",
        "dateModified" : "2019-09-26 00:07:46 &#43;0200 &#43;0200",
        "url" : "https://marcodenisi.dev/en/blog/lambda-step-by-step/",
        "wordCount" : "625",
        "keywords" : [ "aws","lambda","sam","java8","Blog" ]
    }
    </script>
<title>


     Lambda Step by Step 

</title>
<link rel="canonical" href="https://marcodenisi.dev/en/blog/lambda-step-by-step/">







<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    
    <link rel="stylesheet" href="https://marcodenisi.dev/css/reset.css?t=2019-11-03%2016%3a58%3a16.289956151%20%2b0000%20UTC%20m%3d%2b0.095649999">
    <link rel="stylesheet" href="https://marcodenisi.dev/css/pygments.css?t=2019-11-03%2016%3a58%3a16.289956151%20%2b0000%20UTC%20m%3d%2b0.095649999">
    <link rel="stylesheet" href="https://marcodenisi.dev/css/main.css?t=2019-11-03%2016%3a58%3a16.289956151%20%2b0000%20UTC%20m%3d%2b0.095649999">
    
        <link rel="stylesheet" href="https://marcodenisi.dev/css/override.css?t=2019-11-03%2016%3a58%3a16.289956151%20%2b0000%20UTC%20m%3d%2b0.095649999">
    




<link rel="shortcut icon"

    href="https://marcodenisi.dev/img/favicon/favicon.ico"

>








</head>


<body lang="it">

<section class="header">
    <div class="container">
        <div class="content">
            
                
                
                
                
                
                    
                
                    
                
                    
                
                    
                
                    
                
                
                <a href="https://marcodenisi.dev/en/"><img class="avatar" src="https://marcodenisi.dev/img/profile_square_small.png" srcset="https://marcodenisi.dev/img/profile_square_small.png 1x"></a>
            
            <a href="https://marcodenisi.dev/en/"><div class="name">Marco Denisi</div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-blog"><a href="https://marcodenisi.dev/en/blog/"><span>Blog</span></a></li>
                    
                        <li class="nav-about"><a href="https://marcodenisi.dev/en/about/"><span>About</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//github.com/marcodenisi" target="_blank" rel="noopener"><img class="icon" src="https://marcodenisi.dev/img/github.svg" alt="github" /></a>
        

        

        

	

        

        

        
            <a href="//linkedin.com/in/marco-denisi" target="_blank" rel="noopener"><img class="icon" src="https://marcodenisi.dev/img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        

        
            <a href="mailto:marcodenisi35@gmail.com"><img class="icon" src="https://marcodenisi.dev/img/email.svg" alt="email" /></a>
        

        

        
            
                <a href="https://marcodenisi.dev/it/blog/lambda-step-by-step/"><img class="icon flag" src="https://marcodenisi.dev/img/flags/it.svg"></a>
            
        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Lambda Step by Step

</div>

                    <div class="initials"><a href="https://marcodenisi.dev">ad</a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='26/09/2019 00:07'>26/09/2019</div>
                    
                    
		    <div class="reading-time"><div class="middot"></div>3 minutes read</div>
                    
                </div>
            </div>
            <div class="markdown">
                

<p>During last weeks, I&rsquo;ve worked a lot with <a href="https://aws.amazon.com/it/lambda/">AWS Lambda</a>.</p>

<p>The main challenge I had was to look for a method to locally test those functions. Of course, it is possible to do some partial code execution as part of unit/integration test setup, but that won’t be close enough to production setup.</p>

<p>I&rsquo;d like to build a sort of how-to guide in order to have a reference in the future. To do so, I have to:</p>

<ul>
<li>write a lambda that <em>does stuff</em></li>
<li>with the help of SAM (and its CLI), invoke and debug the function.</li>
</ul>

<p>Let&rsquo;s start!</p>

<h1 id="sam">SAM</h1>

<p>SAM (<em>Serverless Application Model</em>) is an open source framework used to define, test and deploy serverless applications. SAM uses a <em>.yaml</em> file (also called <em>template</em>) that is then transformed into an AWS CloudFormation file.</p>

<p>In this scenario, I&rsquo;ll use SAM to define the lambda function endpoint. Using its CLI, I&rsquo;ll also be able to invoke (and debug) it locally.</p>

<p><a href="https://aws.amazon.com/it/serverless/sam/">Here</a> is the SAM official documentation.</p>

<h1 id="lambda-creation">Lambda Creation</h1>

<p>SAM CLI has a really helpful function to create a lambda stub:</p>

<pre><code class="language-bash">sam init --runtime java8 --name StuffApi
</code></pre>

<p>This command creates an entire maven project with some example classes. The following structure is created:</p>

<pre><code class="language-bash">StuffApi
├── README.md 
├── pom.xml
├── src
│   ├── main
│   │   └── java
│   │       └── helloworld
│   │           ├── App.java              &lt;-- Lambda
│   │           └── GatewayResponse.java  &lt;-- API Gateway Response POJO 
│   └── test
│       └── java
│           └── helloworld
│               └── AppTest.java
└── template.yaml
</code></pre>

<p>I&rsquo;d suggest you to take a look at the <code>README.md</code>, which contains a lot of useful indications on next steps.</p>

<p>Now, it&rsquo;s time to code. Let&rsquo;s write a simple lambda function returning a <code>User</code> object:</p>

<pre><code class="language-java">public class StuffHandler implements RequestHandler&lt;Void, GatewayResponse&lt;UserDto&gt;&gt; {
    @Override
    public GatewayResponse&lt;UserDto&gt; handleRequest(final Void input, final Context context) {
        Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();
        headers.put(&quot;Content-Type&quot;, &quot;application/json&quot;);
        return new GatewayResponse&lt;&gt;(new UserDto.UserDtoBuilder().setEmail(&quot;foo@bar.com&quot;).setUsername(&quot;foobar&quot;).build(),
                headers,
                200);
    }
}
</code></pre>

<p>The response is wrapped inside a <code>GatewayResponse</code> object. It contains:</p>

<ul>
<li><code>body</code>: the actual lambda response</li>
<li><code>headers</code>: custom response headers (e.g. <code>Content-Type</code>)</li>
<li><code>statusCode</code>: the response HTTP code (e.g. 200)</li>
</ul>

<h1 id="sam-template-creation">SAM Template Creation</h1>

<p>Let&rsquo;s move on to the most interesting thing, the SAM template. Here&rsquo;s the first template snippet:</p>

<pre><code class="language-yaml">AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: &gt;
    StuffApi
    Sample SAM Template for StuffApi
Globals:
    Function:
        Timeout: 20
</code></pre>

<p>Here we can found generic information that SAM uses to parse the template (e.g. <code>AWSTemplateFormatVersion</code>). Then we have the <code>Globals</code> section: all lambda global variables are defined here.</p>

<pre><code class="language-yaml">Resources:
  StuffFunction:
        Type: AWS::Serverless::Function
        Properties:
            CodeUri: target/StuffApi-1.0.jar
            Handler: dev.marcodenisi.stuff.StuffHandler::handleRequest
            Runtime: java8
            Events:
                Stuff:
                    Type: Api
                    Properties:
                        Path: /stuff
                        Method: get
</code></pre>

<p>In this second section, the actual <em>Lambda Function</em> is defined. We name it (<code>StuffFunction</code>) and we define the <em>jar</em> containing its source code along with the <code>handler</code> class.</p>

<p>Under <code>Events</code>, we define an API Gateway (<code>Type: Api</code>) responding to HTTP GET calls (<code>Method: get</code>) at the <em>path</em> <code>/stuff</code>.</p>

<h1 id="invoking-and-debugging">Invoking and debugging</h1>

<p>First things first, we have to package the lambda source code. I&rsquo;m using Java and Maven, so I have to run the <code>mvn package</code> command to create the <em>jar</em>.</p>

<p>To invoke the lambda, just run SAM CLI <code>invoke</code> command:</p>

<pre><code class="language-bash">sam local invoke &quot;StuffFunction&quot; --no-event
... // service logs
{&quot;body&quot;:{&quot;username&quot;:&quot;foobar&quot;,&quot;email&quot;:&quot;foo@bar.com&quot;},&quot;headers&quot;:{&quot;Content-Type&quot;:&quot;application/json&quot;},&quot;statusCode&quot;:200}
</code></pre>

<p>This command does nothing but create a small docker container. In fact, the first run will be quite slow because of the docker image download. Next runs will be faster. <a href="https://hub.docker.com/r/lambci/lambda/">Here</a> is the docker image documentation.</p>

<p>The <code>--no-event</code> option specifies that the lambda function won&rsquo;t accept anything in input. In the case input events are needed, the <code>sam local generate-event</code> command comes in handy.</p>

<p>To debug, just add the <code>-d</code> flag:</p>

<pre><code class="language-bash">sam local invoke &quot;StuffFunction&quot; --no-event -d 5858
</code></pre>

<p>In this way, the lambda function won&rsquo;t be executed until a debugger is attached to the specified port (5858 in the example).</p>

<p><img src="https://marcodenisi.dev/gifs/thats_all_folks.gif" alt="That's all folks!" /></p>

                <br>
                
                  <div class="tags">
                    <strong>Tags:</strong>
                  
                    <a href="https://marcodenisi.dev/en/tags/aws">aws</a>
                  
                    <a href="https://marcodenisi.dev/en/tags/lambda">lambda</a>
                  
                    <a href="https://marcodenisi.dev/en/tags/sam">sam</a>
                  
                    <a href="https://marcodenisi.dev/en/tags/java8">java8</a>
                  
                  </div>
                  <br />
                
                <p class="back-to-posts"><a href="https://marcodenisi.dev/en/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</section>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-143191600-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/yaml.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>





</body>
</html>

