<!DOCTYPE html>
<html lang="it">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Marco Denisi">
<meta name="description" content="Nelle ultime settimane ho avuto molto a che fare con la creazione di AWS Lambda.
La difficoltà più grossa con cui ho dovuto fare i conti è stata quella di testare in locale queste funzioni. Sicuramente è possibile (anzi, necessario) scrivere unit ed integration test, ma mi piace comunque testare in un ambiente il più vicino possibile a quello di produzione.
Vorrei quindi costruire una sorta di guida per avere un reminder per i futuri sviluppi.">

<meta property="og:title" content="Lambda Step by Step" />
<meta property="og:description" content="Nelle ultime settimane ho avuto molto a che fare con la creazione di AWS Lambda.
La difficoltà più grossa con cui ho dovuto fare i conti è stata quella di testare in locale queste funzioni. Sicuramente è possibile (anzi, necessario) scrivere unit ed integration test, ma mi piace comunque testare in un ambiente il più vicino possibile a quello di produzione.
Vorrei quindi costruire una sorta di guida per avere un reminder per i futuri sviluppi." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marcodenisi.dev/it/blog/lambda-step-by-step/" />
<meta property="article:published_time" content="2019-09-26T00:07:46&#43;02:00"/>
<meta property="article:modified_time" content="2019-09-26T00:07:46&#43;02:00"/>


<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://marcodenisi.dev"
        },
        "articleSection" : "blog",
        "name" : "Lambda Step by Step",
        "headline" : "Lambda Step by Step",
        "description" : "Nelle ultime settimane ho avuto molto a che fare con la creazione di AWS Lambda.
La difficoltà più grossa con cui ho dovuto fare i conti è stata quella di testare in locale queste funzioni. Sicuramente è possibile (anzi, necessario) scrivere unit ed integration test, ma mi piace comunque testare in un ambiente il più vicino possibile a quello di produzione.
Vorrei quindi costruire una sorta di guida per avere un reminder per i futuri sviluppi.",
        "inLanguage" : "it",
        "author" : "Marco Denisi",
        "creator" : "Marco Denisi",
        "publisher": "Marco Denisi",
        "accountablePerson" : "Marco Denisi",
        "copyrightHolder" : "Marco Denisi",
        "copyrightYear" : "2019",
        "datePublished": "2019-09-26 00:07:46 &#43;0200 &#43;0200",
        "dateModified" : "2019-09-26 00:07:46 &#43;0200 &#43;0200",
        "url" : "https://marcodenisi.dev/it/blog/lambda-step-by-step/",
        "wordCount" : "674",
        "keywords" : [ "aws","lambda","sam","java8","Blog" ]
    }
    </script>
<title>


     Lambda Step by Step 

</title>
<link rel="canonical" href="https://marcodenisi.dev/it/blog/lambda-step-by-step/">







<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    
    <link rel="stylesheet" href="https://marcodenisi.dev/css/reset.css?t=2019-11-03%2016%3a58%3a16.258321784%20%2b0000%20UTC%20m%3d%2b0.064015632">
    <link rel="stylesheet" href="https://marcodenisi.dev/css/pygments.css?t=2019-11-03%2016%3a58%3a16.258321784%20%2b0000%20UTC%20m%3d%2b0.064015632">
    <link rel="stylesheet" href="https://marcodenisi.dev/css/main.css?t=2019-11-03%2016%3a58%3a16.258321784%20%2b0000%20UTC%20m%3d%2b0.064015632">
    
        <link rel="stylesheet" href="https://marcodenisi.dev/css/override.css?t=2019-11-03%2016%3a58%3a16.258321784%20%2b0000%20UTC%20m%3d%2b0.064015632">
    




<link rel="shortcut icon"

    href="https://marcodenisi.dev/img/favicon/favicon.ico"

>








</head>


<body lang="it">

<section class="header">
    <div class="container">
        <div class="content">
            
                
                
                
                
                
                    
                
                    
                
                    
                
                    
                
                    
                
                
                <a href="https://marcodenisi.dev/it/"><img class="avatar" src="https://marcodenisi.dev/img/profile_square_small.png" srcset="https://marcodenisi.dev/img/profile_square_small.png 1x"></a>
            
            <a href="https://marcodenisi.dev/it/"><div class="name">Marco Denisi</div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-blog"><a href="https://marcodenisi.dev/it/blog/"><span>Blog</span></a></li>
                    
                        <li class="nav-about"><a href="https://marcodenisi.dev/it/about/"><span>Chi Sono</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//github.com/marcodenisi" target="_blank" rel="noopener"><img class="icon" src="https://marcodenisi.dev/img/github.svg" alt="github" /></a>
        

        

        

	

        

        

        
            <a href="//linkedin.com/in/marco-denisi" target="_blank" rel="noopener"><img class="icon" src="https://marcodenisi.dev/img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        

        
            <a href="mailto:marcodenisi35@gmail.com"><img class="icon" src="https://marcodenisi.dev/img/email.svg" alt="email" /></a>
        

        

        
            
                <a href="https://marcodenisi.dev/en/blog/lambda-step-by-step/"><img class="icon flag" src="https://marcodenisi.dev/img/flags/en.svg"></a>
            
        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Lambda Step by Step

</div>

                    <div class="initials"><a href="https://marcodenisi.dev">ad</a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='26/09/2019 00:07'>26/09/2019</div>
                    
                    
		    <div class="reading-time"><div class="middot"></div>4 minuti di lettura</div>
                    
                </div>
            </div>
            <div class="markdown">
                

<p>Nelle ultime settimane ho avuto molto a che fare con la creazione di <a href="https://aws.amazon.com/it/lambda/">AWS Lambda</a>.</p>

<p>La difficoltà più grossa con cui ho dovuto fare i conti è stata quella di testare in locale queste funzioni. Sicuramente è possibile (anzi, necessario) scrivere unit ed integration test, ma mi piace comunque testare in un ambiente il più vicino possibile a quello di produzione.</p>

<p>Vorrei quindi costruire una sorta di guida per avere un reminder per i futuri sviluppi. Per fare ciò sono necessari i seguenti step:</p>

<ul>
<li>scrivere una lambda che <em>fa cose</em></li>
<li>con l&rsquo;aiuto di SAM (e la sua CLI), invocare e debuggare la funzione</li>
</ul>

<p>Let&rsquo;s start!</p>

<h1 id="sam">SAM</h1>

<p>SAM (<em>Serverless Application Model</em>) è un framework open source per definire, testare, ed infine <em>deployare</em> applicazioni <em>serverless</em>. Il tutto scrivendo un file <em>.yaml</em> (template) che SAM si occuperà di trasformare in sintassi AWS CloudFormation.</p>

<p>In questo caso, ci servirà per definire l&rsquo;endpoint al quale la lambda risponderà. Tramite la sua CLI, riusciremo anche a lanciare (e debuggare) la lambda stessa in locale.</p>

<p>Un po&rsquo; di documentazione nella <a href="https://aws.amazon.com/it/serverless/sam/">pagina ufficiale</a>.</p>

<h1 id="creazione-delle-lambda">Creazione delle Lambda</h1>

<p>La SAM CLI offre una funzionalità molto comoda per creare uno stub di lambda. Basterà infatti lanciare</p>

<pre><code class="language-bash">sam init --runtime java8 --name StuffApi
</code></pre>

<p>per creare un intero progetto maven con delle classi di esempio. In particolare, verrà creata questa struttura:</p>

<pre><code class="language-bash">StuffApi
├── README.md 
├── pom.xml
├── src
│   ├── main
│   │   └── java
│   │       └── helloworld
│   │           ├── App.java              &lt;-- Lambda
│   │           └── GatewayResponse.java  &lt;-- POJO per risposta API Gateway 
│   └── test
│       └── java
│           └── helloworld
│               └── AppTest.java
└── template.yaml
</code></pre>

<p>Vi consiglio di dare una lettura soprattutto al file <code>README.md</code>, che contiene molte indicazione utili sui prossimi passi da seguire.</p>

<p>Implementiamo una semplice lambda che restituisce un oggetto <code>User</code>:</p>

<pre><code class="language-java">public class StuffHandler implements RequestHandler&lt;Void, GatewayResponse&lt;UserDto&gt;&gt; {
    @Override
    public GatewayResponse&lt;UserDto&gt; handleRequest(final Void input, final Context context) {
        Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();
        headers.put(&quot;Content-Type&quot;, &quot;application/json&quot;);
        return new GatewayResponse&lt;&gt;(new UserDto.UserDtoBuilder().setEmail(&quot;foo@bar.com&quot;).setUsername(&quot;foobar&quot;).build(),
                headers,
                200);
    }
}
</code></pre>

<p>La risposta è <em>wrappata</em> all&rsquo;interno dell&rsquo;oggetto <code>GatewayResponse</code>. Questo oggetto, contiene tre campi:</p>

<ul>
<li><code>body</code>: la risposta vera e propria della lambda</li>
<li><code>headers</code>: eventuali header che vogliamo dare in risposta (in questo caso ho aggiunto l&rsquo;header <code>Content-Type</code>)</li>
<li><code>statusCode</code>: il codice HTTP restituito (nel mio caso, 200)</li>
</ul>

<h1 id="creazione-del-sam-template">Creazione del SAM template</h1>

<p>Veniamo ora alla &ldquo;ciccia&rdquo;, il SAM template. Ecco la prima parte del template yaml:</p>

<pre><code class="language-yaml">AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: &gt;
    StuffApi
    Sample SAM Template for StuffApi
Globals:
    Function:
        Timeout: 20
</code></pre>

<p>Qui sono contenute delle informazioni generiche che servono a SAM per parsare il file (<code>AWSTemplateFormatVersion</code> ad esempio). La parte più interessante riguarda la sezione <code>Globals</code>: qui infatti possiamo definire tutte le variabili globali della nostra lambda.</p>

<pre><code class="language-yaml">Resources:
  StuffFunction:
        Type: AWS::Serverless::Function
        Properties:
            CodeUri: target/StuffApi-1.0.jar
            Handler: dev.marcodenisi.stuff.StuffHandler::handleRequest
            Runtime: java8
            Events:
                Stuff:
                    Type: Api
                    Properties:
                        Path: /stuff
                        Method: get
</code></pre>

<p>In questa seconda sezione, definiamo la <em>Lambda Function</em> vera e propria. Le diamo un nome (<code>StuffFunction</code>), definiamo il nome del <em>jar</em> contenente il codice sorgente ed anche la classe <code>handler</code>, con relativo metodo che si occuperà di servire il contenuto.</p>

<p>Sotto <code>Events</code>, definiamo un API Gateway (<code>Type: Api</code>) che risponde a chiamate HTTP GET (<code>Method: get</code>) al <em>path</em> <code>/stuff</code>.</p>

<h1 id="invocare-e-debuggare-la-funzione">Invocare e debuggare la funzione</h1>

<p>Per prima cosa, <em>pacchettizziamo</em> la lambda. Nel mio caso, usando Java + Maven, basta lanciare <code>mvn package</code> per creare il <em>jar</em>.</p>

<p>Per invocare la lambda, utilizziamo il comando di <code>invoke</code> della SAM cli.</p>

<pre><code class="language-bash">sam local invoke &quot;StuffFunction&quot; --no-event
... // log &quot;di servizio&quot;
{&quot;body&quot;:{&quot;username&quot;:&quot;foobar&quot;,&quot;email&quot;:&quot;foo@bar.com&quot;},&quot;headers&quot;:{&quot;Content-Type&quot;:&quot;application/json&quot;},&quot;statusCode&quot;:200}
</code></pre>

<p>Questo comando non fa nient&rsquo;altro che creare un piccolo container docker. Infatti, il primo start sarà piuttosto lento a causa del download dell&rsquo;immagine, per poi velocizzarsi le volte successive. <a href="https://hub.docker.com/r/lambci/lambda/">Ecco</a> la documentazione dell&rsquo;immagine docker utilizzata.</p>

<p>L&rsquo;opzione <code>--no-event</code> specifica che alla lambda non serve nulla in ingresso. Nel caso dovessero servire degli eventi specifici, il comando <code>sam local generate-event</code> è utile per creare degli eventi di esempio.</p>

<p>Per debuggare, basta aggiungere un flag:</p>

<pre><code class="language-bash">sam local invoke &quot;StuffFunction&quot; --no-event -d 5858
</code></pre>

<p>In questo modo, la lambda non verrà eseguita fino a che un processo si attaccherà in debug alla porta specificata (la 5858, nel mio caso).</p>

<p><img src="https://marcodenisi.dev/gifs/thats_all_folks.gif" alt="That's all folks!" /></p>

                <br>
                
                  <div class="tags">
                    <strong>Tags:</strong>
                  
                    <a href="https://marcodenisi.dev/it/tags/aws">aws</a>
                  
                    <a href="https://marcodenisi.dev/it/tags/lambda">lambda</a>
                  
                    <a href="https://marcodenisi.dev/it/tags/sam">sam</a>
                  
                    <a href="https://marcodenisi.dev/it/tags/java8">java8</a>
                  
                  </div>
                  <br />
                
                <p class="back-to-posts"><a href="https://marcodenisi.dev/it/blog">Indietro ai post</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</section>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-143191600-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/yaml.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>





</body>
</html>

